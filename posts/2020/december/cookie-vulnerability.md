title: "3 cookie related CVEs!!"
keywords:
- ruby
- dotnet
- php
- cookies
- hackerone
tags:
- ruby
- dotnet
- php
- cookies
- hackerone
categories:
- security disclosures
thumbnailImage: https://images.fletchto99.com/blog/2020/december/cookie-vulnerability/thumbnail.png
date: 2020/11/01
---

Back in June my team and I found a vulnerability in the way multiple languages parse cookies which could allow a potential attacker to bypass cookie prefixes. ([CVE-2020-8184](https://hackerone.com/reports/895727), [CVE-2020-7070](https://bugs.php.net/bug.php?id=79699), [CVE-2020-1045](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-1045))

<!-- excerpt -->

{% image center clear https://images.fletchto99.com/blog/2020/december/cookie-vulnerability/banner.jpg %}


Back in June my team and I found a vulnerability in the way multiple frameworks/languages parse cookies which could allow a potential attacker to bypass cookie prefixes. At its core the vulnerability exploits the fact that these languages decode the entire cookie string, which includes the name of the cookie. In most cases that's fine however in some unique cases certain [assumptions](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#Attributes) are made around the naming of cookies which this exploit is able to bypass. Rails (rack), Dotnet and PHP were all affected.

In each of the affected languages the flaw allowed for a `__%48ost-` or `__%53ecure-` cookie to be set without meeting the required attributes (I.e. set without HTTPS, from root domain, or from a secure page). This means a malicious cookie set by an attacker could potentially craft a malicious `__%48ost-` and set it on their victim. _Note:_ another exploit such as XSS would be required to actually set the cookie. What makes this dangerous is that an XSS vulnerability on a subdomain could even be used, bypassing any assumptions the server has around the cookie, for example `__Host-` cookies only being set on the parent domain while `__%48ost` cookies can be set anywhere.

If an attacker had XSS on a subdomain they could use the following snippet to set a malicious `__%48ost-` cookie that would be read by the parent domain as a `__Host-` cookie. Then the vulnerable language would decode the cookie and treat it as a `__Host-` prefixed cookie:

{% codeblock lang:js %}
document.cookie = "__%48ost-evil=evil; domain=.example.com";
{% endcodeblock %}


This is the example test case I submitted to rails to catch this issue. Similar tests were also submitted to PHP and Dotnet:

{% codeblock lang:ruby %}
describe Rack::Utils, "malicious cookie" do
  # Fails and __Host-evil reads the malicious value and sets it as the cookie
  # rather than reading the actual __Host cookie
  #
  # Furthermore, browsers enforce HostOnly for `__Host-` cookies but they would
  # not enforce it for "__%48ost" cookies so a malicious script could potentially
  # set this cookie knowing it would be parsed as the `__Host-` cookie
  #
  # Lastly, when the cookie is made it could be set with the `.example.com` domain
  # wildcard, thus a malicious script on a subdomain could set the cookie and it
  # would be parsed by the root domain
  #
  # This is due to the cookie being unescaped, thus:
  # URI.unescape("__%48ost-evil") => "__Host-evil"
  #
  # Currently fails, should be passing
  it "doesnt parse malicious __Host cookie" do
    env = Rack::MockRequest.env_for("", "HTTP_COOKIE" => "__%48ost-evil=evil;__Host-evil=abc")
    cookies = Rack::Utils.parse_cookies(env)
    cookies.must_equal({ "__%48ost-evil" => "evil", "__Host-evil" => "abc"  })
  end
end
{% endcodeblock %}

Ultimately this vulnerability lead to 3 CVEs:
- [CVE-2020-8184](https://hackerone.com/reports/895727) in rails (rack)
- [CVE-2020-7070](https://bugs.php.net/bug.php?id=79699) in PHP
- [CVE-2020-1045](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-1045) in Dotnet


Thanks to my team at GitHub for helping me identify this issue! Thanks to the Rails, PHP and Microsoft dotnet teams for the fixes!
<!-- more -->
